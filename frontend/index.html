<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Movie & TV Explorer</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Movie & TV Explorer</h1>
  <div id="searchBar">
    <input id="search" placeholder="Title" />
    <select id="type">
      <option value="movie">Movie</option>
      <option value="tv">TV Show</option>
    </select>
    <button onclick="search()">Search</button>
  </div>
  <h2>Results</h2>
  <div id="results"></div>

  <h2>Watchlist</h2>
  <div id="watchlist"></div>

<script>
async function search() {
  const query = document.getElementById('search').value;
  const type = document.getElementById('type').value;
  const res = await fetch(`/search?q=${encodeURIComponent(query)}&type=${type}`);
  const data = await res.json();
  const container = document.getElementById('results');
  container.innerHTML = '';
  if (data.results) {
    data.results.forEach(item => container.appendChild(renderResult(item, type)));
  } else if (data.error) {
    container.textContent = data.error;
  }
}

function renderResult(item, type) {
  const div = document.createElement('div');
  div.className = 'card';
  const title = type === 'movie' ? item.title : item.name;
  div.innerHTML = `<h4>${title}</h4>`;
  if (item.poster_path) {
    const img = document.createElement('img');
    img.src = 'https://image.tmdb.org/t/p/w200' + item.poster_path;
    div.appendChild(img);
  }
  div.innerHTML += `<p>Rating: ${item.vote_average}</p>`;
  div.innerHTML += `<p>${item.overview || ''}</p>`;
  const btn = document.createElement('button');
  btn.textContent = 'Add to watchlist';
  btn.onclick = () => addToWatchlist({
    id: item.id,
    type,
    title,
    poster_path: item.poster_path,
    overview: item.overview,
    vote_average: item.vote_average
  });
  div.appendChild(btn);
  return div;
}

async function loadWatchlist() {
  const res = await fetch('/watchlist');
  const data = await res.json();
  const container = document.getElementById('watchlist');
  container.innerHTML = '';
  data.forEach(item => container.appendChild(renderWatchItem(item)));
}

function renderWatchItem(item) {
  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `<h4>${item.title}</h4>`;
  if (item.poster_path) {
    const img = document.createElement('img');
    img.src = 'https://image.tmdb.org/t/p/w200' + item.poster_path;
    div.appendChild(img);
  }
  div.innerHTML += `<p>Rating: ${item.vote_average}</p>`;
  const notes = document.createElement('textarea');
  notes.value = item.notes || '';
  notes.onchange = () => updateNotes(item.id, notes.value);
  div.appendChild(notes);
  const del = document.createElement('button');
  del.textContent = 'Remove';
  del.onclick = () => removeItem(item.id);
  div.appendChild(del);
  const done = document.createElement('button');
  done.textContent = 'Watched';
  done.onclick = () => markWatched(item.id);
  div.appendChild(done);
  return div;
}

async function addToWatchlist(item) {
  await fetch('/watchlist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(item)
  });
  loadWatchlist();
}

async function updateNotes(id, notes) {
  await fetch(`/watchlist/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ notes })
  });
}

async function removeItem(id) {
  await fetch(`/watchlist/${id}`, { method: 'DELETE' });
  loadWatchlist();
}

async function markWatched(id) {
  await fetch(`/watchlist/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ watched: true })
  });
  loadWatchlist();
}

loadWatchlist();
</script>
</body>
</html>
