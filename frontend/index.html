<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Movie & TV Explorer</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>Movie &amp; TV Explorer</h1>
  </header>

  <section id="searchBar">
    <input id="search" type="text" placeholder="Search for a title…" />
    <select id="type">
      <option value="movie">Movie</option>
      <option value="tv">TV Show</option>
    </select>
    <button onclick="search()">Search</button>
  </section>

  <!-- Auth Buttons placed below search bar -->
  <section id="authButtons">
    <button onclick="location.href='login.html'" class="btn-nav">Login</button>
    <button onclick="location.href='signup.html'" class="btn-nav">Sign Up</button>
  </section>

  <main>
    <h2>Results</h2>
    <div id="results"></div>

    <h2>Watchlist</h2>
    <div id="watchlist"></div>
  </main>

  <script>
    async function search() {
      const query = document.getElementById('search').value;
      const type = document.getElementById('type').value;
      const res = await fetch(`/search?q=${encodeURIComponent(query)}&type=${type}`);
      const data = await res.json();
      const container = document.getElementById('results');
      container.innerHTML = '';
      if (data.results) {
        data.results.forEach(item => container.appendChild(renderResult(item, type)));
      } else if (data.error) {
        container.textContent = data.error;
      }
    }

    function renderResult(item, type) {
      const div = document.createElement('div');
      div.className = 'card';
      const title = type === 'movie' ? item.title : item.name;
      div.innerHTML = `
        <div class="poster"${item.poster_path ? '' : ' style="background:#333;"'}>
          ${item.poster_path ? `<img src="https://image.tmdb.org/t/p/w200${item.poster_path}" alt="${title}" />` : ''}
        </div>
        <div class="info">
          <h4>${title}</h4>
          <p class="rating">⭐ ${item.vote_average}</p>
          <p class="overview">${item.overview || ''}</p>
          <button class="btn-watchlist">Add to Watchlist</button>
        </div>`;
      div.querySelector('.btn-watchlist').onclick = () => addToWatchlist({
        id: item.id,
        type,
        title,
        poster_path: item.poster_path,
        overview: item.overview,
        vote_average: item.vote_average
      });
      return div;
    }

    async function loadWatchlist() {
      const res = await fetch('/watchlist');
      const data = await res.json();
      const container = document.getElementById('watchlist');
      container.innerHTML = '';
      data.forEach(item => container.appendChild(renderWatchItem(item)));
    }

    function renderWatchItem(item) {
      const div = document.createElement('div');
      div.className = item.watched ? 'card watched' : 'card';
      div.innerHTML = `
        <div class="poster"${item.poster_path ? '' : ' style="background:#333;"'}>
          ${item.poster_path ? `<img src="https://image.tmdb.org/t/p/w200${item.poster_path}" alt="${item.title}" />` : ''}
        </div>
        <div class="info">
          <h4>${item.title}</h4>
          <p class="rating">⭐ ${item.vote_average}</p>
          <textarea placeholder="Your notes…">${item.notes || ''}</textarea>
          <div class="actions">
            <button class="btn-remove">Remove</button>
            <button class="btn-done">Watched</button>
          </div>
        </div>`;
      div.querySelector('.btn-remove').onclick = () => removeItem(item.id);
      div.querySelector('.btn-done').onclick = () => markWatched(item.id);
      div.querySelector('textarea').onchange = e => updateNotes(item.id, e.target.value);
      return div;
    }

    async function addToWatchlist(item) {
      await fetch('/watchlist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(item),
      });
      loadWatchlist();
    }

    async function updateNotes(id, notes) {
      await fetch(`/watchlist/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes }),
      });
    }

    async function removeItem(id) {
      await fetch(`/watchlist/${id}`, { method: 'DELETE' });
      loadWatchlist();
    }

    async function markWatched(id) {
      await fetch(`/watchlist/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ watched: true }),
      });
      loadWatchlist();
    }

    // initialize on page load
    loadWatchlist();
  </script>
</body>
</html>
